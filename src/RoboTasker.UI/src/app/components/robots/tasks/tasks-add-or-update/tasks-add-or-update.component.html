<div class="create-or-update-task-wrapper">
  <h2>{{ isEdit() ? 'Editing' : 'Creating' }} a task</h2>
  <form class="my-2" [formGroup]="form" (ngSubmit)="submit()">
    <div class="tabs">
      <p-tabs value="0" scrollable>
        <p-tablist>
          <p-tab value="0">Main Info</p-tab>
          <p-tab value="1">Properties</p-tab>
          <p-tab value="2">Requirements</p-tab>
          <p-tab value="3">Data</p-tab>
          <p-tab value="4">Files</p-tab>
        </p-tablist>
        <p-tabpanels>
          <p-tabpanel value="0">
            <div class="main-info">
              <div class="general-section mt-2">
                <div class="p-1">
                  <div class="name flex flex-column gap-1">
                    <label for="name">Name</label>
                    <input pInputText type="text" id="name" formControlName="name">
                  </div>
                  <div class="description flex flex-column gap-1 mt-1">
                    <label for="description">Description</label>
                    <textarea pTextarea formControlName="description" id="description" rows="3" autoResize></textarea>
                  </div>
                </div>
              </div>
              <div class="other-info mt-2">
                <h3>Other information</h3>
                <div class="p-1">
                  <div class="priority flex flex-column gap-1 mt-2">
                    <label>Priority</label>
                    <p-select [options]="priorityRange" formControlName="priority"></p-select>
                  </div>
                  <div class="complexity flex flex-column gap-1 mt-2">
                    <label>Complexity</label>
                    <p-inputNumber min="1" max="5" [step]="0.1" showButtons formControlName="complexity"/>
                  </div>
                  <div class="estimated-duration flex flex-column gap-1 mt-2">
                    Estimated duration
                    <div class="estimate flex gap-2">
                      <p-input-mask formControlName="estimatedDuration" slotChar="_" mask="999:99" placeholder="HH:mm"
                                    styleClass="w-full" class="w-full"/>
                    </div>
                  </div>
                </div>
              </div>
            </div>
          </p-tabpanel>
          <p-tabpanel value="1">
            <div class="properties mt-1" formArrayName="properties">
              <p-button label="Add property" icon="pi pi-plus" outlined styleClass="mt-1 w-full" (onClick)="addProperty()"/>
              @for (propertyControl of propertiesArray.controls; track propertyControl; let i = $index) {
                <div class="property flex lg:flex-row flex-column gap-2 mt-5 lg:mt-3 w-full align-items-end" [formGroupName]="i">
                  <div class="property-key w-full flex flex-column gap-1 flex-grow-1">
                    <label for="prop-key">Key</label>
                    <input pInputText type="text" id="prop-key" formControlName="key">
                  </div>
                  <div class="property-value w-full flex flex-column gap-1 flex-grow-1">
                    <label for="prop-value">Value</label>
                    <input pInputText type="text" id="prop-value" formControlName="value">
                  </div>
                  <p-button (onClick)="removeProperty(i)" icon="pi pi-trash" severity="danger" class="lg:w-3rem w-full" styleClass="lg:w-3rem w-full"/>
                </div>
              }
            </div>
          </p-tabpanel>
          <p-tabpanel value="2">
            <div class="requirements" formArrayName="requirements">
              <p-button [disabled]="allAdded()" (onClick)="addRequirement()" label="Add requirement" icon="pi pi-plus" outlined styleClass="mt-1 w-full"/>
              <div class="capabilities-list">
                @for (requirementControl of requirementsArray.controls; track requirementControl; let i = $index) {
                  <div class="requirement mt-3 flex flex-column lg:flex-row gap-1 align-items-end" [formGroupName]="i">
                    <div class="requirement-capability max-w-25rem flex-grow-1 flex flex-column gap-1">
                      <label for="requirement-cap-id">Capability</label>
                      <p-select [options]="groupedCapabilities()" group class="w-full md:w-56"
                                (onChange)="onCapabilitySelect($event)"
                                id="requirement-cap-id"
                                formControlName="capabilityId"/>
                    </div>
                    <div class="requirement-level flex-grow-1 flex flex-column gap-1">
                      <label for="requirement-level">Level</label>
                      <p-select [options]="requirementsLevels" optionValue="key" optionLabel="label"
                                class="w-full" styleClass="w-full"
                                id="requirement-level"
                                formControlName="level"
                      />
                    </div>
                    <p-button (onClick)="removeRequirement(i)" icon="pi pi-trash" severity="danger" class="lg:w-3rem w-full" styleClass="lg:w-3rem w-full"/>
                  </div>
                }
              </div>
            </div>
          </p-tabpanel>
          <p-tabpanel value="3">
            <div class="data" formArrayName="data">
              <p-button (onClick)="addDataItem()" label="Add data" icon="pi pi-plus" outlined styleClass="mt-1 w-full"/>
              <div class="data-list mt-3">
                @for (dataControl of dataArray.controls; track dataControl; let i = $index) {
                  <div class="data mt-3" [formGroupName]="i">
                    <div class="data-name flex flex-column gap-1">
                      <label for="data-name">Key</label>
                      <input pInputText id="data-name" type="text" formControlName="key">
                    </div>
                    <div class="data-type flex flex-column gap-1 mt-1">
                      <label for="data-type">Type</label>
                      <p-select [options]="dataTypes" id="data-type" optionValue="key" formControlName="type"/>
                    </div>
                    <div class="data-value flex flex-column gap-1 mt-1">
                      @let type = dataArray.at(i).get('type')?.value;
                      <label for="data-input">Value</label>
                      <div class="input w-full" id="data-input">
                        @switch (type) {
                          @case (TaskDataType.String) {
                            <textarea pTextarea formControlName="value" class="w-full"></textarea>
                          }
                          @case (TaskDataType.Boolean) {
                            <p-checkbox binary formControlName="value"/>
                          }
                          @case (TaskDataType.DateTime) {
                            <p-date-picker formControlName="value" class="w-full"/>
                          }
                          @case (TaskDataType.Number) {
                            <p-input-number formControlName="value" class="w-full"/>
                          }
                        }
                      </div>
                    </div>
                    <p-button outlined (onClick)="removeDataItem(i)" icon="pi pi-trash" severity="danger" class="w-full" styleClass="w-full mt-1"/>
                    <p-divider class="mb-2"/>
                  </div>
                }
              </div>
            </div>
          </p-tabpanel>
          <p-tabpanel value="4">
            <div class="existing-files">
              @for (file of existingFiles(); track file.fileName) {
                @let isDeleted = isFileDeleted(file.fileName);
                <div class="existing-file flex justify-content-between align-items-center">
                  <div class="file">
                    <span class="{{isDeleted ? 'line-through text-red-500' : ''}} transition-duration-300">
                      {{file.fileName}} ({{file.size}} KB)
                    </span>
                  </div>
                  <div class="file-action">
                    @if (isDeleted) {
                      <p-button (onClick)="undeleteFile(file.fileName)" icon="pi pi-undo" outlined severity="contrast"/>
                    }
                    @else {
                      <p-button (onClick)="deleteFile(file.fileName)" icon="pi pi-trash" outlined severity="danger"/>
                    }
                  </div>
                </div>
                <p-divider/>
              }
            </div>
            <div class="upload-files mt-3">
              <p-fileupload maxFileSize="209715200" multiple (onSelect)="onFilesSelect($event)" mode="advanced" [showCancelButton]="false" [showUploadButton]="false">
                <ng-template #empty>
                  <div>Select or drag and drop files to here to upload.</div>
                </ng-template>
              </p-fileupload>
            </div>
          </p-tabpanel>
        </p-tabpanels>
      </p-tabs>
    </div>
    <div class="actions mt-3">
      <p-button type="submit" label="Submit"/>
    </div>
  </form>
</div>
